<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>// Place global declarations here.
chan syn;
chan synack;
chan fin;
chan noack;
chan rest;
chan ackn;

const int RETRY_MAX_COUNT = 2;
int will_be_rec_succ_from_client;
int retry_count ;
int will_be_rec_succ_from_server;
int seq_need_to_be_ack;




</declaration>
	<template>
		<name x="5" y="5">tcp_client</name>
		<declaration>// Place local declarations here.
int seq =0;
int ack = 0;




</declaration>
		<location id="id0" x="-357" y="-42">
			<name x="-442" y="-51">CLOSED</name>
		</location>
		<location id="id1" x="85" y="-68">
			<name x="-17" y="-25">SYN_ACK_SERVER_RECIVED</name>
		</location>
		<location id="id2" x="-170" y="102">
			<name x="-280" y="110">SYN_RESENT</name>
		</location>
		<location id="id3" x="323" y="-42">
			<name x="365" y="-51">ACK_SYN_SERVER_SUCC</name>
		</location>
		<location id="id4" x="136" y="-127">
			<name x="153" y="-127">ACK_SYN_SERVER_RECIVED_NOTSUCC</name>
		</location>
		<location id="id5" x="-170" y="-42">
			<name x="-161" y="-34">SYN_SENT</name>
		</location>
		<init ref="id0"/>
		<transition id="id6">
			<source ref="id1"/>
			<target ref="id3"/>
			<label kind="guard" x="170" y="-76">will_be_rec_succ_from_server</label>
			<label kind="synchronisation" x="136" y="-59">ackn!</label>
			<label kind="assignment" x="59" y="-42">ack = seq_need_to_be_ack+1</label>
			<nail x="102" y="-42"/>
		</transition>
		<transition id="id7">
			<source ref="id1"/>
			<target ref="id4"/>
			<label kind="guard" x="136" y="-110">!will_be_rec_succ_from_server</label>
			<label kind="synchronisation" x="136" y="-93">noack!</label>
			<nail x="119" y="-68"/>
		</transition>
		<transition id="id8">
			<source ref="id4"/>
			<target ref="id0"/>
			<label kind="guard" x="-330" y="-157">retry_count&gt; RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="-330" y="-140">rest!</label>
			<label kind="assignment" x="-330" y="-123">ack =0, seq=0</label>
			<nail x="-348" y="-119"/>
			<nail x="-348" y="-68"/>
		</transition>
		<transition id="id9">
			<source ref="id4"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="68" y="-110">syn?</label>
		</transition>
		<transition id="id10">
			<source ref="id4"/>
			<target ref="id0"/>
			<label kind="guard" x="-339" y="-208">retry_count&gt; RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="-339" y="-191">rest?</label>
			<label kind="assignment" x="-339" y="-174">ack =0, seq=0</label>
			<nail x="136" y="-178"/>
			<nail x="-357" y="-170"/>
		</transition>
		<transition id="id11">
			<source ref="id2"/>
			<target ref="id0"/>
			<label kind="guard" x="-484" y="-8">retry_count&gt; RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="-272" y="17">rest?</label>
			<label kind="assignment" x="-272" y="34">ack =0, seq=0</label>
			<nail x="-187" y="76"/>
			<nail x="-195" y="59"/>
			<nail x="-314" y="-17"/>
			<nail x="-340" y="-25"/>
		</transition>
		<transition id="id12">
			<source ref="id2"/>
			<target ref="id0"/>
			<label kind="guard" x="-501" y="68">retry_count&gt; RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="-323" y="42">rest!</label>
			<label kind="assignment" x="-314" y="85">ack =0, seq=0</label>
			<nail x="-212" y="93"/>
			<nail x="-246" y="76"/>
			<nail x="-331" y="17"/>
		</transition>
		<transition id="id13">
			<source ref="id5"/>
			<target ref="id2"/>
			<label kind="guard" x="-161" y="51">!will_be_rec_succ_from_client</label>
			<label kind="synchronisation" x="-187" y="-17">noack?</label>
			<nail x="-170" y="-25"/>
		</transition>
		<transition id="id14">
			<source ref="id5"/>
			<target ref="id1"/>
			<label kind="guard" x="-144" y="-68">will_be_rec_succ_from_client</label>
			<label kind="synchronisation" x="-51" y="-93">synack?</label>
			<nail x="-144" y="-68"/>
			<nail x="51" y="-68"/>
		</transition>
		<transition id="id15">
			<source ref="id0"/>
			<target ref="id5"/>
			<label kind="select" x="-289" y="-110">i : int[0,1]</label>
			<label kind="synchronisation" x="-289" y="-34">syn!</label>
			<label kind="assignment" x="-858" y="-85">will_be_rec_succ_from_client=i,seq =1000 , ack=0,seq_need_to_be_ack=seq</label>
			<nail x="-340" y="-42"/>
		</transition>
		<transition id="id16">
			<source ref="id3"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-279" y="212">fin!</label>
			<label kind="assignment" x="-279" y="229">ack =0, seq=0</label>
			<nail x="323" y="212"/>
			<nail x="289" y="229"/>
			<nail x="-297" y="229"/>
			<nail x="-365" y="170"/>
		</transition>
		<transition id="id17">
			<source ref="id3"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-288" y="-323">fin?</label>
			<label kind="assignment" x="-288" y="-306">ack =0, seq=0</label>
			<nail x="323" y="-289"/>
			<nail x="297" y="-306"/>
			<nail x="-306" y="-306"/>
			<nail x="-340" y="-280"/>
			<nail x="-374" y="-238"/>
			<nail x="-374" y="-59"/>
		</transition>
		<transition id="id18">
			<source ref="id2"/>
			<target ref="id5"/>
			<label kind="select" x="-76" y="-8">i : int [ 0,1]</label>
			<label kind="guard" x="-102" y="25">retry_count &lt;= RETRY_MAX_COUNT &amp;&amp; !will_be_rec_succ_from_client</label>
			<label kind="synchronisation" x="-136" y="93">syn!</label>
			<label kind="assignment" x="-93" y="8">will_be_rec_succ_from_client = i,retry_count++</label>
			<nail x="-153" y="102"/>
			<nail x="-51" y="-42"/>
			<nail x="-144" y="-42"/>
		</transition>
	</template>
	<template>
		<name>tcp_server</name>
		<declaration>int seq =0;
int ack = 0;
</declaration>
		<location id="id19" x="-365" y="-59">
			<name x="-375" y="-93">LISTEN</name>
		</location>
		<location id="id20" x="-170" y="-59">
			<name x="-246" y="-136">SYN_CLIENT_RECEVED</name>
		</location>
		<location id="id21" x="255" y="-85">
			<name x="255" y="-76">CLIENT_ACK_REC_SUCC_SYN_ACK_SENT</name>
		</location>
		<location id="id22" x="348" y="-178">
			<name x="357" y="-212">CLIENT_ACK_REC_SUCC_SYN_ACK_RESENT</name>
		</location>
		<location id="id23" x="0" y="170">
			<name x="-10" y="136">CLIENT_ACK_REC_SUCC_SYN_ACK_SUCC</name>
		</location>
		<location id="id24" x="-246" y="17">
			<name x="-229" y="-17">ACK_REFUSED</name>
		</location>
		<init ref="id19"/>
		<transition id="id25">
			<source ref="id24"/>
			<target ref="id19"/>
			<label kind="guard" x="-314" y="-34">retry_count&gt; RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="-297" y="-17">rest!</label>
			<nail x="-263" y="-25"/>
		</transition>
		<transition id="id26">
			<source ref="id24"/>
			<target ref="id19"/>
			<label kind="guard" x="-374" y="34">retry_count&gt; RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="-348" y="8">rest?</label>
			<nail x="-289" y="17"/>
		</transition>
		<transition id="id27">
			<source ref="id20"/>
			<target ref="id24"/>
			<label kind="guard" x="-221" y="8">!will_be_rec_succ_from_client</label>
			<label kind="synchronisation" x="-136" y="-8">noack!</label>
			<nail x="-153" y="-34"/>
			<nail x="-195" y="8"/>
		</transition>
		<transition id="id28">
			<source ref="id24"/>
			<target ref="id20"/>
			<label kind="synchronisation" x="-221" y="-51">syn?</label>
			<nail x="-221" y="-25"/>
		</transition>
		<transition id="id29">
			<source ref="id23"/>
			<target ref="id19"/>
			<label kind="synchronisation" x="-373" y="76">fin?</label>
			<label kind="assignment" x="-373" y="93">ack =0, seq=0</label>
			<nail x="-59" y="93"/>
			<nail x="-391" y="93"/>
			<nail x="-399" y="-34"/>
		</transition>
		<transition id="id30">
			<source ref="id23"/>
			<target ref="id19"/>
			<label kind="synchronisation" x="-398" y="153">fin!</label>
			<label kind="assignment" x="-398" y="170">ack =0, seq=0</label>
			<nail x="-416" y="170"/>
			<nail x="-416" y="-42"/>
			<nail x="-382" y="-59"/>
		</transition>
		<transition id="id31">
			<source ref="id21"/>
			<target ref="id23"/>
			<label kind="guard" x="59" y="51">will_be_rec_succ_from_server</label>
			<label kind="synchronisation" x="42" y="17">ackn?</label>
		</transition>
		<transition id="id32">
			<source ref="id22"/>
			<target ref="id19"/>
			<label kind="guard" x="-407" y="-327">retry_count&gt; RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="-407" y="-310">rest?</label>
			<label kind="assignment" x="-407" y="-293">ack =0, seq=0</label>
			<nail x="348" y="-297"/>
			<nail x="-425" y="-289"/>
			<nail x="-425" y="-93"/>
		</transition>
		<transition id="id33">
			<source ref="id22"/>
			<target ref="id19"/>
			<label kind="guard" x="-136" y="-280">retry_count&gt; RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="-25" y="-238">rest!</label>
			<label kind="assignment" x="264" y="-221">ack =0, seq=0</label>
			<nail x="340" y="-187"/>
			<nail x="246" y="-255"/>
			<nail x="-374" y="-255"/>
			<nail x="-374" y="-93"/>
		</transition>
		<transition id="id34">
			<source ref="id22"/>
			<target ref="id21"/>
			<label kind="select" x="365" y="-161">j : int[0,1]</label>
			<label kind="guard" x="348" y="-144">retry_count&lt;= RETRY_MAX_COUNT</label>
			<label kind="synchronisation" x="306" y="-110">syn!</label>
			<label kind="assignment" x="340" y="-127">will_be_rec_succ_from_server = j,retry_count++</label>
			<nail x="348" y="-144"/>
		</transition>
		<transition id="id35">
			<source ref="id21"/>
			<target ref="id22"/>
			<label kind="guard" x="59" y="-178">!will_be_rec_succ_from_server</label>
			<label kind="synchronisation" x="238" y="-161">noack?</label>
			<nail x="263" y="-119"/>
			<nail x="314" y="-178"/>
		</transition>
		<transition id="id36">
			<source ref="id20"/>
			<target ref="id21"/>
			<label kind="select" x="93" y="-119">j : int[0,1]</label>
			<label kind="guard" x="-136" y="-110">will_be_rec_succ_from_client</label>
			<label kind="synchronisation" x="187" y="-110">synack!</label>
			<label kind="assignment" x="-136" y="-59">will_be_rec_succ_from_server = j, retry_count = 0 , ack = seq_need_to_be_ack+1,seq=3000 ,seq_need_to_be_ack=seq</label>
			<nail x="-153" y="-85"/>
		</transition>
		<transition id="id37">
			<source ref="id19"/>
			<target ref="id20"/>
			<label kind="synchronisation" x="-289" y="-85">syn?</label>
			<label kind="assignment" x="-347" y="-59">ack =0 ,seq=0</label>
		</transition>
	</template>
	<system>// Place template instantiations here.
TcpClient = tcp_client();
TcpServer = tcp_server();
// List one or more processes to be composed into a system.
system TcpClient , TcpServer;
</system>
	<queries>
		<query>
			<formula>A[] not deadlock</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-12-02 15:33:34 +0100">
			</result>
		</query>
		<query>
			<formula>TcpServer.CLIENT_ACK_REC_SUCC_SYN_ACK_SUCC --&gt; TcpClient.ACK_SYN_SERVER_SUCC</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-12-02 15:33:44 +0100">
			</result>
		</query>
		<query>
			<formula>TcpClient.CLOSED --&gt; TcpServer.LISTEN</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-12-02 15:34:43 +0100">
			</result>
		</query>
		<query>
			<formula>TcpServer.CLIENT_ACK_REC_SUCC_SYN_ACK_SUCC --&gt; TcpClient.ack == TcpServer.seq+1 &amp;&amp; TcpServer.ack == TcpClient.seq+1</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-12-02 15:31:21 +0100">
			</result>
		</query>
	</queries>
</nta>
