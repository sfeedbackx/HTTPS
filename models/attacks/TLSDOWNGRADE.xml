<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>
// Communication channels
chan client_hello, forward_to_server;
chan server_hello, forward_to_client;
broadcast chan connection_established;
chan abort_connection;  // New channel to abort vulnerable connections

// TLS Versions (higher = more secure)
const int TLS_1_3 = 13;  // Modern and secure
const int TLS_1_2 = 12;  // Secure
const int TLS_1_0 = 10;  // Weak and vulnerable

// Message structure to show what's being sent
typedef struct {
    int[0,20] highest_version;
    int[0,20] lowest_version;
    int[0,3] num_versions;
} TLSMessage;

// Global messages
TLSMessage client_original_msg;     // What client creates
TLSMessage attacker_modified_msg;   // What attacker sends
TLSMessage server_response_msg;     // What server responds

int[0,20] client_offered_version = 0;    // What client originally offers
int[0,20] attacker_modified_version = 0; // What attacker sends to server
int[0,20] negotiated_version = 0;        // Final agreed version

// Attack tracking
bool client_hello_intercepted = false;
bool message_modified = false;
bool server_deceived = false;
bool client_deceived = false;

// Attack result flags
bool downgrade_successful = false;
bool connection_vulnerable = false;
bool connection_aborted = false;
bool secure_connection_established = false;
</declaration>
	<template>
		<name>Client</name>
		<location id="id0" x="0" y="0">
			<name x="-10" y="-34">Start</name>
		</location>
		<location id="id1" x="178" y="0">
			<name x="127" y="-42">PrepareMessage</name>
			<committed/>
		</location>
		<location id="id2" x="510" y="0">
			<name x="459" y="-34">SendHello</name>
		</location>
		<location id="id3" x="765" y="0">
			<name x="714" y="-34">WaitResponse</name>
		</location>
		<location id="id4" x="1020" y="0">
			<name x="969" y="-34">ProcessResponse</name>
			<committed/>
		</location>
		<location id="id5" x="1283" y="-212">
			<name x="1232" y="-246">CheckVulnerability</name>
			<committed/>
		</location>
		<location id="id6" x="1734" y="-212">
			<name x="1683" y="-246">ConnectedSecure</name>
		</location>
		<location id="id7" x="1518" y="-442">
			<name x="1467" y="-476">VulnerableDetected</name>
			<committed/>
		</location>
		<location id="id8" x="1785" y="-442">
			<name x="1734" y="-476">ConnectionAbortedOrShowWarning</name>
		</location>
		<init ref="id0"/>
		<transition id="id9">
			<source ref="id0"/>
			<target ref="id1"/>
		</transition>
		<transition id="id10">
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="assignment" x="212" y="8">client_offered_version:=TLS_1_3,
client_original_msg.highest_version:=TLS_1_3,
client_original_msg.lowest_version:=TLS_1_0,
client_original_msg.num_versions:=3</label>
		</transition>
		<transition id="id11">
			<source ref="id2"/>
			<target ref="id3"/>
			<label kind="synchronisation" x="578" y="-20">client_hello!</label>
		</transition>
		<transition id="id12">
			<source ref="id3"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="833" y="-20">forward_to_client?</label>
		</transition>
		<transition id="id13">
			<source ref="id4"/>
			<target ref="id5"/>
			<label kind="assignment" x="1020" y="-136">negotiated_version:=server_response_msg.highest_version,
client_deceived:=(negotiated_version &lt; client_offered_version)</label>
		</transition>
		<transition id="id14">
			<source ref="id5"/>
			<target ref="id6"/>
			<label kind="guard" x="1402" y="-204">negotiated_version &gt;= TLS_1_2</label>
			<label kind="assignment" x="1402" y="-187">connection_vulnerable:=false,
secure_connection_established:=true</label>
		</transition>
		<transition id="id15">
			<source ref="id5"/>
			<target ref="id7"/>
			<label kind="guard" x="1360" y="-408">negotiated_version &lt; TLS_1_2</label>
			<label kind="assignment" x="1360" y="-391">connection_vulnerable:=true</label>
		</transition>
		<transition id="id16">
			<source ref="id6"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="1734" y="-144">connection_established!</label>
			<nail x="1734" y="-144"/>
			<nail x="1811" y="-212"/>
		</transition>
		<transition id="id17">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="1648" y="-442">abort_connection!</label>
			<label kind="assignment" x="1648" y="-425">connection_aborted:=true</label>
		</transition>
	</template>
	<template>
		<name>Server</name>
		<location id="id18" x="-212" y="0">
			<name x="-222" y="-34">Listening</name>
		</location>
		<location id="id19" x="43" y="0">
			<name x="-8" y="-42">ReceiveClientHello</name>
			<committed/>
		</location>
		<location id="id20" x="510" y="0">
			<name x="459" y="-34">AnalyzeVersions</name>
			<committed/>
		</location>
		<location id="id21" x="510" y="-348">
			<name x="459" y="-382">SelectVersion</name>
			<committed/>
		</location>
		<location id="id22" x="1096" y="-348">
			<name x="1045" y="-382">SendResponse</name>
		</location>
		<location id="id23" x="1351" y="-348">
			<name x="1300" y="-382">Ready</name>
		</location>
		<location id="id24" x="1351" y="-595">
			<name x="1300" y="-629">AbortProcessing</name>
		</location>
		<init ref="id18"/>
		<transition id="id25">
			<source ref="id18"/>
			<target ref="id19"/>
			<label kind="synchronisation" x="-153" y="-20">forward_to_server?</label>
		</transition>
		<transition id="id26">
			<source ref="id19"/>
			<target ref="id20"/>
			<label kind="assignment" x="68" y="17">server_deceived:=(attacker_modified_msg.highest_version &lt; TLS_1_3)</label>
		</transition>
		<transition id="id27">
			<source ref="id20"/>
			<target ref="id21"/>
			<label kind="assignment" x="306" y="-153">attacker_modified_version:=attacker_modified_msg.highest_version</label>
		</transition>
		<transition id="id28">
			<source ref="id21"/>
			<target ref="id22"/>
			<label kind="guard" x="807" y="-323">attacker_modified_version &gt;= TLS_1_0</label>
			<label kind="assignment" x="807" y="-306">server_response_msg.highest_version:=attacker_modified_version,
server_response_msg.lowest_version:=attacker_modified_version,
server_response_msg.num_versions:=1</label>
		</transition>
		<transition id="id29">
			<source ref="id22"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="1164" y="-368">server_hello!</label>
		</transition>
		<transition id="id30">
			<source ref="id23"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="1351" y="-280">connection_established?</label>
			<nail x="1351" y="-280"/>
			<nail x="1420" y="-348"/>
		</transition>
		<transition id="id31">
			<source ref="id23"/>
			<target ref="id24"/>
			<label kind="synchronisation" x="1299" y="-493">abort_connection?</label>
		</transition>
	</template>
	<template>
		<name>Attacker</name>
		<location id="id32" x="0" y="0">
			<name x="-10" y="-34">Waiting</name>
		</location>
		<location id="id33" x="255" y="0">
			<name x="204" y="-42">InterceptClientHello</name>
			<committed/>
		</location>
		<location id="id34" x="510" y="0">
			<name x="459" y="-42">InspectMessage</name>
			<committed/>
		</location>
		<location id="id35" x="731" y="0">
			<name x="680" y="-42">StripModernVersions</name>
			<committed/>
		</location>
		<location id="id36" x="1020" y="0">
			<name x="969" y="-42">CreateFakeMessage</name>
			<committed/>
		</location>
		<location id="id37" x="1028" y="-280">
			<name x="977" y="-314">ForwardToServer</name>
			<committed/>
		</location>
		<location id="id38" x="1326" y="-280">
			<name x="1275" y="-314">InterceptServerHello</name>
			<committed/>
		</location>
		<location id="id39" x="1581" y="-280">
			<name x="1530" y="-322">VerifyDowngrade</name>
			<committed/>
		</location>
		<location id="id40" x="1878" y="-280">
			<name x="1827" y="-314">ForwardToClient</name>
			<committed/>
		</location>
		<location id="id41" x="1878" y="-535">
			<name x="1827" y="-565">AttackComplete</name>
		</location>
		<location id="id42" x="1581" y="-535">
			<name x="1530" y="-569">AttackFailed</name>
		</location>
		<init ref="id32"/>
		<transition id="id43">
			<source ref="id32"/>
			<target ref="id33"/>
			<label kind="synchronisation" x="93" y="-20">client_hello?</label>
		</transition>
		<transition id="id44">
			<source ref="id33"/>
			<target ref="id34"/>
			<label kind="assignment" x="272" y="8">client_hello_intercepted:=true,
client_offered_version:=TLS_1_3</label>
		</transition>
		<transition id="id45">
			<source ref="id34"/>
			<target ref="id35"/>
		</transition>
		<transition id="id46">
			<source ref="id35"/>
			<target ref="id36"/>
			<label kind="assignment" x="765" y="17">message_modified:=true</label>
		</transition>
		<transition id="id47">
			<source ref="id36"/>
			<target ref="id37"/>
			<label kind="assignment" x="629" y="-221">attacker_modified_version:=TLS_1_0,
attacker_modified_msg.highest_version:=TLS_1_0,
attacker_modified_msg.lowest_version:=TLS_1_0,
attacker_modified_msg.num_versions:=1</label>
		</transition>
		<transition id="id48">
			<source ref="id37"/>
			<target ref="id38"/>
			<label kind="synchronisation" x="1096" y="-300">forward_to_server!</label>
		</transition>
		<transition id="id49">
			<source ref="id38"/>
			<target ref="id39"/>
			<label kind="synchronisation" x="1411" y="-300">server_hello?</label>
		</transition>
		<transition id="id50">
			<source ref="id39"/>
			<target ref="id40"/>
			<label kind="guard" x="1712" y="-263">!connection_aborted</label>
			<label kind="assignment" x="1712" y="-246">downgrade_successful:=(server_response_msg.highest_version &lt;= TLS_1_0)</label>
		</transition>
		<transition id="id51">
			<source ref="id40"/>
			<target ref="id41"/>
			<label kind="synchronisation" x="1810" y="-425">forward_to_client!</label>
		</transition>
		<transition id="id52">
			<source ref="id39"/>
			<target ref="id42"/>
			<label kind="synchronisation" x="1513" y="-433">abort_connection?</label>
		</transition>
	</template>
	<system>system Client, Server, Attacker;</system>
	<queries>
		<query>
			<formula>E&lt;&gt; downgrade_successful</formula>
			<comment>Can the attacker successfully downgrade the TLS version?</comment>
		</query>
		<query>
			<formula>E&lt;&gt; (Client.ConnectedSecure &amp;&amp; connection_vulnerable == false)</formula>
			<comment>Does the client establish a secure connection?</comment>
		</query>
		<query>
			<formula>E&lt;&gt; (connection_vulnerable &amp;&amp; connection_aborted)</formula>
			<comment>Vulnerable connection detected and aborted</comment>
		</query>
		<query>
			<formula>E&lt;&gt; (negotiated_version == TLS_1_0 &amp;&amp; client_offered_version == TLS_1_3)</formula>
			<comment>Client wanted TLS 1.3 but got TLS 1.0</comment>
		</query>
		<query>
			<formula>A[] (Client.ConnectedSecure imply negotiated_version &gt;= TLS_1_2)</formula>
			<comment>If client is in ConnectedSecure state, it MUST have secure TLS</comment>
		</query>
		<query>
			<formula>E&lt;&gt; (downgrade_successful &amp;&amp; connection_aborted)</formula>
			<comment>Attack succeeds but client detects and aborts</comment>
		</query>
		<query>
			<formula>E&lt;&gt; (server_deceived &amp;&amp; client_deceived &amp;&amp; !connection_aborted)</formula>
			<comment>Both server and client are deceived and connection proceeds</comment>
		</query>
	</queries>
</nta>
