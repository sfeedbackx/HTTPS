<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>// Place global declarations here.
chan syn;
chan synack;
chan ack;
chan rest;
chan finack;
//const int TIMEOUT = 10;
const int RETRY_TIME = 10;
const int MAX_RETRIES = 5;</declaration>
	<template>
		<name>TcpServer</name>
		<declaration>clock s;
int retry_count_s = 0;</declaration>
		<location id="id0" x="-400" y="-50">
			<name x="-451" y="-16">LISTEN</name>
		</location>
		<location id="id1" x="-221" y="-59">
			<name x="-255" y="-93">SYN_RCVD</name>
		</location>
		<location id="id2" x="340" y="-51">
			<name x="306" y="-85">ESTABLISHED</name>
		</location>
		<location id="id3" x="-68" y="-59">
			<name x="-93" y="-102">SYNACK_SENT</name>
			<label kind="invariant" x="-161" y="-127">s &lt;= RETRY_TIME &amp;&amp; retry_count_s &lt; MAX_RETRIES</label>
		</location>
		<location id="id4" x="510" y="-51">
			<name x="500" y="-85">DATA_RCVD</name>
		</location>
		<location id="id5" x="705" y="-60">
			<name x="816" y="-76">DATA_SENT</name>
			<label kind="invariant" x="739" y="-102">s &lt;= RETRY_TIME &amp;&amp; retry_count_s &lt; MAX_RETRIES</label>
		</location>
		<location id="id6" x="731" y="272">
			<name x="721" y="238">FIN_RCVD</name>
		</location>
		<location id="id7" x="722" y="85">
		</location>
		<init ref="id0"/>
		<transition id="id8">
			<source ref="id4"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-323" y="297">rest?</label>
			<nail x="-331" y="280"/>
		</transition>
		<transition id="id9">
			<source ref="id5"/>
			<target ref="id0"/>
			<label kind="guard" x="-93" y="-399">s &gt;= RETRY_TIME &amp;&amp; retry_count_s &gt;= MAX_RETRIES</label>
			<label kind="synchronisation" x="-245" y="-263">rest!</label>
			<nail x="-263" y="-433"/>
			<nail x="-569" y="-110"/>
		</transition>
		<transition id="id10">
			<source ref="id5"/>
			<target ref="id5"/>
			<label kind="guard" x="664" y="-246">s &gt;= RETRY_TIME &amp;&amp; retry_count_s &lt; MAX_RETRIES</label>
			<label kind="synchronisation" x="664" y="-229">synack!</label>
			<label kind="assignment" x="664" y="-212">s = 0, retry_count_s++</label>
			<nail x="646" y="-221"/>
			<nail x="850" y="-204"/>
		</transition>
		<transition id="id11">
			<source ref="id7"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="726" y="161">finack?</label>
		</transition>
		<transition id="id12">
			<source ref="id5"/>
			<target ref="id7"/>
			<label kind="guard" x="713" y="-17">retry_count_s &lt; MAX_RETRIES</label>
			<label kind="synchronisation" x="713" y="0">ack?</label>
		</transition>
		<transition id="id13">
			<source ref="id6"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="144" y="357">ack!</label>
			<nail x="127" y="425"/>
		</transition>
		<transition id="id14">
			<source ref="id4"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="578" y="-76">synack!</label>
			<label kind="assignment" x="527" y="-42">s=0,retry_count_s=0</label>
		</transition>
		<transition id="id15">
			<source ref="id2"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="399" y="-76">syn?</label>
		</transition>
		<transition id="id16">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-272" y="8">rest?</label>
			<nail x="-289" y="34"/>
		</transition>
		<transition id="id17">
			<source ref="id3"/>
			<target ref="id3"/>
			<label kind="guard" x="-289" y="59">s &gt;= RETRY_TIME &amp;&amp; retry_count_s &lt; MAX_RETRIES</label>
			<label kind="synchronisation" x="-127" y="25">synack!</label>
			<label kind="assignment" x="-42" y="25">s = 0, retry_count_s++</label>
			<nail x="-170" y="51"/>
			<nail x="-51" y="51"/>
		</transition>
		<transition id="id18">
			<source ref="id1"/>
			<target ref="id3"/>
			<label kind="synchronisation" x="-170" y="-85">synack!</label>
			<label kind="assignment" x="-246" y="-51">s=0,retry_count_s=0</label>
		</transition>
		<transition id="id19">
			<source ref="id3"/>
			<target ref="id0"/>
			<label kind="guard" x="-467" y="-229">s &gt;= RETRY_TIME &amp;&amp; retry_count_s &gt;= MAX_RETRIES</label>
			<label kind="synchronisation" x="-263" y="-187">rest!</label>
			<nail x="-76" y="-68"/>
			<nail x="-315" y="-186"/>
		</transition>
		<transition id="id20">
			<source ref="id3"/>
			<target ref="id2"/>
			<label kind="guard" x="8" y="-51">retry_count_s &lt; MAX_RETRIES</label>
			<label kind="synchronisation" x="119" y="-85">ack?</label>
		</transition>
		<transition id="id21">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="-382" y="-67">syn?</label>
		</transition>
	</template>
	<template>
		<name x="5" y="5">TcpClient</name>
		<declaration>// Place local declarations here.
clock t;
int retry_count = 0;
</declaration>
		<location id="id22" x="-748" y="-119">
			<name x="-774" y="-153">CLOSED</name>
		</location>
		<location id="id23" x="-502" y="-119">
			<name x="-536" y="-153">SYN_SENT</name>
			<label kind="invariant" x="-595" y="-178">retry_count&lt;MAX_RETRIES &amp;&amp; t&lt;=RETRY_TIME</label>
		</location>
		<location id="id24" x="-93" y="-136">
			<name x="-153" y="-187">ACK_SEND</name>
		</location>
		<location id="id25" x="152" y="-110">
			<name x="135" y="-153">ESTABLISHED</name>
		</location>
		<location id="id26" x="272" y="-110">
			<name x="238" y="-161">DATA_SENT</name>
			<label kind="invariant" x="221" y="-204">retry_count&lt;MAX_RETRIES &amp;&amp; t&lt;=RETRY_TIME</label>
		</location>
		<location id="id27" x="442" y="-119">
			<name x="399" y="-170">DATA_ACK</name>
		</location>
		<location id="id28" x="637" y="-136">
			<name x="619" y="-178">DATA_REC</name>
		</location>
		<location id="id29" x="661" y="94">
			<name x="651" y="60">FIN_SENT</name>
			<label kind="invariant" x="680" y="85">retry_count&lt;MAX_RETRIES &amp;&amp; t&lt;=RETRY_TIME</label>
		</location>
		<init ref="id22"/>
		<transition id="id30">
			<source ref="id27"/>
			<target ref="id22"/>
			<label kind="synchronisation" x="-41" y="-361">rest?</label>
			<nail x="-59" y="-569"/>
		</transition>
		<transition id="id31">
			<source ref="id29"/>
			<target ref="id22"/>
			<label kind="guard" x="-569" y="306">t &gt; RETRY_TIME &amp;&amp; retry_count &gt;= MAX_RETRIES</label>
			<nail x="-705" y="289"/>
			<nail x="-969" y="8"/>
		</transition>
		<transition id="id32">
			<source ref="id29"/>
			<target ref="id29"/>
			<label kind="synchronisation" x="535" y="136">finack!</label>
			<label kind="assignment" x="535" y="153">t = 0, retry_count++</label>
			<nail x="517" y="213"/>
			<nail x="687" y="213"/>
		</transition>
		<transition id="id33">
			<source ref="id26"/>
			<target ref="id22"/>
			<label kind="guard" x="-24" y="-356">t &gt;= RETRY_TIME &amp;&amp; retry_count &gt;= MAX_RETRIES</label>
			<label kind="synchronisation" x="-42" y="-425">rest!</label>
			<nail x="-42" y="-535"/>
		</transition>
		<transition id="id34">
			<source ref="id26"/>
			<target ref="id26"/>
			<label kind="guard" x="-93" y="-42">t &gt;= RETRY_TIME &amp;&amp; retry_count &lt; MAX_RETRIES</label>
			<label kind="synchronisation" x="297" y="-34">syn!</label>
			<label kind="assignment" x="263" y="25">t = 0, retry_count++</label>
			<nail x="289" y="34"/>
			<nail x="365" y="-17"/>
		</transition>
		<transition id="id35">
			<source ref="id29"/>
			<target ref="id22"/>
			<label kind="guard" x="-119" y="68">retry_count&lt;MAX_RETRIES &amp;&amp; t&lt;=RETRY_TIME</label>
			<label kind="synchronisation" x="-271" y="89">ack?</label>
			<nail x="-289" y="127"/>
			<nail x="-799" y="76"/>
		</transition>
		<transition id="id36">
			<source ref="id28"/>
			<target ref="id29"/>
			<label kind="synchronisation" x="654" y="-42">finack!</label>
			<label kind="assignment" x="501" y="-8">t=0,retry_count=0</label>
		</transition>
		<transition id="id37">
			<source ref="id27"/>
			<target ref="id28"/>
			<label kind="synchronisation" x="460" y="-144">ack!</label>
		</transition>
		<transition id="id38">
			<source ref="id26"/>
			<target ref="id27"/>
			<label kind="guard" x="289" y="-102">t &lt;= RETRY_TIME &amp;&amp; retry_count&lt;MAX_RETRIES</label>
			<label kind="synchronisation" x="290" y="-131">synack?</label>
		</transition>
		<transition id="id39">
			<source ref="id25"/>
			<target ref="id26"/>
			<label kind="synchronisation" x="195" y="-136">syn!</label>
			<label kind="assignment" x="127" y="-93">t=0,retry_count=0</label>
		</transition>
		<transition id="id40">
			<source ref="id24"/>
			<target ref="id25"/>
			<label kind="guard" x="-59" y="-178">retry_count&lt;MAX_RETRIES</label>
			<label kind="synchronisation" x="-8" y="-102">ack!</label>
		</transition>
		<transition id="id41">
			<source ref="id23"/>
			<target ref="id23"/>
			<label kind="guard" x="-578" y="-25">t &gt;= RETRY_TIME &amp;&amp; retry_count &lt; MAX_RETRIES</label>
			<label kind="synchronisation" x="-510" y="-59">syn!</label>
			<label kind="assignment" x="-510" y="-9">t = 0, retry_count++</label>
			<nail x="-527" y="-25"/>
			<nail x="-468" y="-42"/>
		</transition>
		<transition id="id42">
			<source ref="id23"/>
			<target ref="id22"/>
			<label kind="guard" x="-672" y="34">t &gt;= RETRY_TIME &amp;&amp; retry_count&gt;=MAX_RETRIES</label>
			<label kind="synchronisation" x="-603" y="-59">rest!</label>
			<nail x="-621" y="34"/>
		</transition>
		<transition id="id43">
			<source ref="id23"/>
			<target ref="id24"/>
			<label kind="guard" x="-425" y="-102">t &lt;= RETRY_TIME &amp;&amp; retry_count&lt;MAX_RETRIES</label>
			<label kind="synchronisation" x="-290" y="-144">synack?</label>
			<label kind="assignment" x="-332" y="-119">t=0,retry_count=0</label>
		</transition>
		<transition id="id44">
			<source ref="id22"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="-621" y="-153">syn!</label>
			<label kind="assignment" x="-680" y="-119">t=0,retry_count=0</label>
		</transition>
	</template>
	<system>// Place template instantiations here.
C = TcpClient();
S = TcpServer();
// List one or more processes to be composed into a system.
system C,S;
</system>
	<queries>
		<query>
			<formula>A[] not deadlock</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-11-11 19:36:17 +0100">
			</result>
		</query>
		<query>
			<formula>E&lt;&gt; C.ESTABLISHED and S.ESTABLISHED</formula>
			<comment>if client established connection the server should also establish connection</comment>
			<result outcome="success" type="quality" timestamp="2025-11-11 19:36:21 +0100">
			</result>
		</query>
		<query>
			<formula>A[] (C.SYN_SENT imply C.t &lt;= TIMEOUT)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-11-10 07:46:14 +0100">
			</result>
		</query>
		<query>
			<formula>A[] not (C.ESTABLISHED and S.LISTEN)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-11-11 19:36:23 +0100">
			</result>
		</query>
		<query>
			<formula>A[] C.retry_count &lt; MAX_RETRIES</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-11-10 07:47:03 +0100">
			</result>
		</query>
		<query>
			<formula>A[] (C.ESTABLISHED imply S.ESTABLISHED)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-11-11 19:36:25 +0100">
			</result>
		</query>
		<query>
			<formula>A[] (C.retry_count &gt;= MAX_RETRIES imply  C.CLOSED and S.LISTEN)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-11-11 19:36:26 +0100">
			</result>
		</query>
	</queries>
</nta>
